<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Harmony DJ Pro</title>

<link rel="stylesheet" href="style.css">
</head>

<body>

<header>
<h1>Harmony DJ</h1>
<p>Analyse automatique MP3</p>
</header>

<section class="card">
<h2>Importer tes morceaux</h2>
<input type="file" id="audioInput" multiple accept="audio/*">
<p class="info">Sélectionne plusieurs MP3</p>
</section>

<section class="card">
<h2>Playlist analysée</h2>
<ul id="playlist"></ul>
</section>

<script>

const audioContext = new (window.AudioContext || window.webkitAudioContext)();

const camelotMap={
"C":"8B","Am":"8A","G":"9B","Em":"9A",
"D":"10B","Bm":"10A","A":"11B","F#m":"11A",
"E":"12B","C#m":"12A","B":"1B","G#m":"1A",
"F#":"2B","D#m":"2A","C#":"3B","A#m":"3A",
"G#":"4B","Fm":"4A","D#":"5B","Cm":"5A",
"A#":"6B","Gm":"6A","F":"7B","Dm":"7A"
};

document.getElementById("audioInput")
.addEventListener("change", async function(e){

const files=[...e.target.files];

for(const file of files){

    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

    const bpm = estimateBPM(audioBuffer);
    const key = estimateKey(audioBuffer);

    addTrack(file.name,bpm,key);
}
});

function estimateBPM(buffer){

    const data = buffer.getChannelData(0);
    let peaks=[];

    for(let i=0;i<data.length;i+=10000){
        peaks.push(Math.abs(data[i]));
    }

    let avg = peaks.reduce((a,b)=>a+b)/peaks.length;

    return Math.round(60 + avg*120); // estimation simple
}

function estimateKey(buffer){

    // estimation simplifiée (démo)
    const keys=["Am","C","G","Em","Dm","F"];
    return keys[Math.floor(Math.random()*keys.length)];
}

function addTrack(title,bpm,key){

const camelot = camelotMap[key] || "?";

document.getElementById("playlist").innerHTML+=`
<li>
<div>
<strong>${title}</strong>
<span>${bpm} BPM • ${key} • ${camelot}</span>
</div>
</li>`;
}

</script>

</body>
</html>
